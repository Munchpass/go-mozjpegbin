machine:
  services:
    - docker
dependencies:
    pre:
      - >
        if [ ! -d /opt/mozjpeg/bin ]; then
          sudo apt-get update && sudo apt-get install -y --no-install-recommends g++ make autoconf automake libtool nasm wget
          wget https://github.com/mozilla/mozjpeg/releases/download/v3.2-pre/mozjpeg-3.2-release-source.tar.gz
          tar -xvzf mozjpeg-3.2-release-source.tar.gz
          cd mozjpeg
          ./configure:
          sudo make install
        fi
        sudo ln -s /opt/mozjpeg/bin/jpegtran /usr/local/bin/jpegtran
        sudo ln -s /opt/mozjpeg/bin/cjpeg /usr/local/bin/cjpeg
    cache_directories:
      - "/opt/mozjpeg"
test:
  override:
    - go test -v ./...
    - docker build -f docker/Dockerfile.alpine --rm=false -t test-alpine-image .